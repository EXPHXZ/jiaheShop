<!DOCTYPE html>
<html lang = "en">
    <head>
        <meta charset = "UTF-8">
        <meta http-equiv = "X-UA-Compatible" content = "IE=edge">
        <meta name = "viewport" content = "width=device-width, initial-scale=1.0">
        <title>订单详情</title>
        <link rel = "stylesheet" href = "../css/homepage.css">
    </head>

    <body>
        <div id = "app">
            <el-container>
                <el-header>
                    <el-menu class = "el-menu-demo" mode = "horizontal" :default-active = "activeIndex" background-color = "#202124"
                        text-color = "#fff" active-text-color = "#ffd04b">
                        <el-menu-item index = "1">
                            <i class = "el-icon-s-goods"></i>
                            <a href = "./homepage.html" target = "_blank">首页</a>
                        </el-menu-item>
                        <el-menu-item index = "2">
                            <i class = "el-icon-shopping-cart-2"></i>
                            <a href = "https://www.ele.me" target = "_blank">购物车</a>
                        </el-menu-item>
                        <a v-if = "!isLogin" class = "users" @click = "login">登录</a>
                        <a v-if = "isLogin" class = "users-right" @click = "logout">退出登录</a>
                        <a v-if = "isLogin" class = "users" href = "usersHome.html">个人中心</a>
                    </el-menu>
                </el-header>
                <el-container>
                    <el-container>
                        <el-main>
                            <div class = "main-top">
                                <img src = "../images/logo.png">
                                <el-form :inline = "true" :model = "formInline" class = "demo-form-inline">
                                    <el-form-item class = "input-search">
                                        <el-col :span = "8">
                                            <el-input v-model = "description" placeholder = "搜索"></el-input>
                                        </el-col>
                                    </el-form-item>
                                    <el-form-item>
                                        <el-button icon = "el-icon-search" @click = "search">搜索</el-button>
                                    </el-form-item>
                                </el-form>
                            </div>
                            <div class = "order">
                                <h3 class = "discount-h">
                                    <i class = "el-icon-sell"></i>
                                    订单详情
                                </h3>
                                <el-table
                                        :data="orderDetails"
                                        tooltip-effect="dark"
                                        style="width: 100%">
                                    <el-table-column
                                            prop="id"
                                            label="订单ID"
                                            width="120">
                                    </el-table-column>
                                    <el-table-column
                                            prop="detail"
                                            label="订单详情"
                                            width="300">
                                    </el-table-column>
                                    <el-table-column
                                            prop="username"
                                            label="下单用户"
                                    >
                                    </el-table-column>
                                    <el-table-column
                                            prop="address.location"
                                            label="收货地址"
                                            width="300"
                                    >
                                    </el-table-column>
                                    <el-table-column
                                            prop="address.contacts"
                                            label="收货人"
                                    >
                                    </el-table-column>
                                    <el-table-column
                                            prop="address.contactsPhone"
                                            label="联系电话"
                                    >
                                    </el-table-column>
                                    <el-table-column
                                            prop="price"
                                            label="金额"
                                    >
                                    </el-table-column>
                                    <el-table-column
                                            prop="submitTime"
                                            label="提交时间"
                                    >
                                    </el-table-column>
                                    <el-table-column
                                            prop="statusText"
                                            label="状态"
                                    >
                                    </el-table-column>
                                    <el-table-column
                                            label="操作"
                                    >
                                    <template slot-scope="scope">
                                        <el-row>
                                            <el-button type="primary" @click="searchUpdate(scope.row)" round>申请售后</el-button>
                                        </el-row>
                                    </template>
                                    </el-table-column>
                                </el-table>
                            </div>
                        </el-main>
                    </el-container>
                </el-container>
            </el-container>
        </div>

        <script src = "../js/vue.js"></script>
        <script src = "../element-ui/lib/index.js"></script>
        <script src = "../js/axios-0.18.0.js"></script>
        <link rel = "stylesheet" href = "../element-ui/lib/theme-chalk/index.css">

        <script>
            new Vue({
                el: "#app",

                data() {
                    return {

                        orderDetails:[],

                        activeIndex: '1',

                        searchForm: {
                        },

                        //分页所需数据
                        pagination: {
                            current: 1,
                            pageSize: 16,
                        },

                        user:{
                        },

                        commodities:[],

                        isLogin: false,

                        description:"",

                        status:"",

                    }
                },

                methods: {
                    handleSelectionChange(val) {
                        this.multipleSelection = val;
                    },


                    search() {
                        this.getCommodities()
                    },

                    //分页换页
                    handleCurrentChange(val) {
                        console.log(`当前页: ${val}`);
                        this.pagination.current = val;
                        // 查询下一页上架的商品
                    },


                    getOrderDetail(orderId){
                        axios.get("/order/searchOrder/" + this.pagination.current + "/"+this.pagination.pageSize+"/1/"+orderId).then((res) => {
                            res.data.data.records.forEach((item) => {
                                this.orderDetails=item.orderCommodityList
                            });
                            this.orderDetails.forEach((item) => {
                                axios.get("/commodity/"+item.commodityId).then((res) => {
                                    item.commodity = res.data.data
                                })
                            })
                            console.log(this.orderDetails)
                            this.pagination.total = res.data.data.total;
                            this.pagination.pageSize = res.data.data.size;
                            this.pagination.current = res.data.data.current;
                        })
                    },

                    getImage(image){
                        console.log("/common/download?name=${image}")
                        return `/common/download?name=${image}`
                    },
                    login() {
                        window.localStorage.setItem("prePage", window.location.href)
                        window.location.href = "usersLogin.html"
                    },

                    logout() {
                        axios.get("/usersManagement/logout").then((resp) => {
                            if (resp.data.code === 20061) {
                                this.$message({showClose: true, message: resp.data.msg, type: "success"})
                                window.location.href = "homepage.html"
                            }
                            else if (resp.data.code === 20062)
                                this.$message({showClose: true, message: resp.data.msg, type: "error"})
                            else
                                this.$message({showClose: true, message: resp.data.msg, type: "error"})
                        })
                    }
                },

                mounted(){
                    //获取用户信息
                    axios.get("/usersManagement/getLoginUser").then((resp) => {
                        if (resp.data.code === 20031)
                            this.user = resp.data.data
                        if (this.user !== null)
                            this.isLogin = true
                    })
                    const params = window.location.search
                    const orderId = params.split("=")[1]
                    this.getOrderDetail(orderId)
                }
            })
        </script>
    </body>
</html>